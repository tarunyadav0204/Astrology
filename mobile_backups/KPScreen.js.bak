import React, { useState, useEffect, useRef } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, ActivityIndicator, Animated, Platform } from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import { SafeAreaView } from 'react-native-safe-area-context';
import Ionicons from '@expo/vector-icons/Ionicons';
import { kpAPI } from '../services/api';
import { useTranslation } from 'react-i18next';
import { useTheme } from '../context/ThemeContext';
import NativeSelectorChip from '../components/Common/NativeSelectorChip';

const PlanetaryTable = ({ data, theme, colors }) => {
    if (!data || data.length === 0) return <Text style={[styles.errorText, { color: colors.textSecondary }]}>No data available</Text>;

    const getNakshatraInfo = (longitude) => {
        const nakshatras = ['Ashwini', 'Bharani', 'Krittika', 'Rohini', 'Mrigashira', 'Ardra', 'Punarvasu', 'Pushya', 'Ashlesha', 'Magha', 'Purva Phalguni', 'Uttara Phalguni', 'Hasta', 'Chitra', 'Swati', 'Vishakha', 'Anuradha', 'Jyeshtha', 'Mula', 'Purva Ashadha', 'Uttara Ashadha', 'Shravana', 'Dhanishta', 'Shatabhisha', 'Purva Bhadrapada', 'Uttara Bhadrapada', 'Revati'];
        const nakIndex = Math.floor(longitude / 13.333333);
        const nakPosition = longitude % 13.333333;
        const pada = Math.floor(nakPosition / 3.333333) + 1;
        return { name: nakshatras[nakIndex], pada };
    };
    
    const shortPlanet = (name) => {
        const map = { 
            'Sun': 'Su', 'Moon': 'Mo', 'Mars': 'Ma', 'Mercury': 'Me', 
            'Jupiter': 'Ju', 'Venus': 'Ve', 'Saturn': 'Sa', 'Rahu': 'Ra', 
            'Ketu': 'Ke', 'Ascendant': 'Asc' 
        };
        return map[name] || name.substring(0, 2);
    };

    return (
        <ScrollView horizontal showsHorizontalScrollIndicator={false}>
            <View style={styles.table}>
                <View style={styles.tableRow}>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 60 }]}>Planet</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 60 }]}>Deg</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 90 }]}>Star</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 40 }]}>Pd</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>SL</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>NL</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>SB</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>SS</Text>
                </View>
                {data.map((item, index) => {
                    const nakInfo = getNakshatraInfo(item.longitude);
                    return (
                        <View key={index} style={[styles.tableRow, index % 2 === 0 && styles.tableRowAlt]}>
                            <Text style={[styles.tableCell, { color: colors.primary, width: 60 }]}>{shortPlanet(item.planet)}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 60 }]}>{item.longitude.toFixed(1)}Â°</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 90 }]}>{nakInfo.name}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 40 }]}>{nakInfo.pada}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.sign_lord)}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.star_lord)}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.sub_lord)}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.sub_sub_lord)}</Text>
                        </View>
                    );
                })}
            </View>
        </ScrollView>
    );
};

const CuspalTable = ({ data, theme, colors }) => {
    if (!data || data.length === 0) return <Text style={[styles.errorText, { color: colors.textSecondary }]}>No data available</Text>;

    const getNakshatraInfo = (longitude) => {
        const nakshatras = ['Ashwini', 'Bharani', 'Krittika', 'Rohini', 'Mrigashira', 'Ardra', 'Punarvasu', 'Pushya', 'Ashlesha', 'Magha', 'Purva Phalguni', 'Uttara Phalguni', 'Hasta', 'Chitra', 'Swati', 'Vishakha', 'Anuradha', 'Jyeshtha', 'Mula', 'Purva Ashadha', 'Uttara Ashadha', 'Shravana', 'Dhanishta', 'Shatabhisha', 'Purva Bhadrapada', 'Uttara Bhadrapada', 'Revati'];
        const nakIndex = Math.floor(longitude / 13.333333);
        const nakPosition = longitude % 13.333333;
        const pada = Math.floor(nakPosition / 3.333333) + 1;
        return { name: nakshatras[nakIndex], pada };
    };
    
    const shortPlanet = (name) => {
        const map = { 
            'Sun': 'Su', 'Moon': 'Mo', 'Mars': 'Ma', 'Mercury': 'Me', 
            'Jupiter': 'Ju', 'Venus': 'Ve', 'Saturn': 'Sa', 'Rahu': 'Ra', 
            'Ketu': 'Ke', 'Ascendant': 'Asc' 
        };
        return map[name] || name.substring(0, 2);
    };

    return (
        <ScrollView horizontal showsHorizontalScrollIndicator={false}>
            <View style={styles.table}>
                <View style={styles.tableRow}>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>Cusp</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 60 }]}>Deg</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 90 }]}>Star</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 40 }]}>Pd</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>SL</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>NL</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>SB</Text>
                    <Text style={[styles.tableHeader, { color: colors.text, width: 50 }]}>SS</Text>
                </View>
                {data.map((item, index) => {
                    const nakInfo = getNakshatraInfo(item.longitude);
                    return (
                        <View key={index} style={[styles.tableRow, index % 2 === 0 && styles.tableRowAlt]}>
                            <Text style={[styles.tableCell, { color: colors.primary, width: 50 }]}>{item.cusp}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 60 }]}>{item.longitude.toFixed(1)}Â°</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 90 }]}>{nakInfo.name}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 40 }]}>{nakInfo.pada}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.sign_lord)}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.star_lord)}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.sub_lord)}</Text>
                            <Text style={[styles.tableCell, { color: colors.text, width: 50 }]}>{shortPlanet(item.sub_sub_lord)}</Text>
                        </View>
                    );
                })}
            </View>
        </ScrollView>
    );
};

const SignificatorsView = ({ data, theme, colors }) => {
    if (!data) return <Text style={[styles.errorText, { color: colors.textSecondary }]}>No data available</Text>;
    
    return (
        <ScrollView showsVerticalScrollIndicator={false}>
            {Object.entries(data).map(([house, significators]) => (
                <View key={house} style={[styles.significatorCard, { backgroundColor: theme === 'dark' ? 'rgba(255, 255, 255, 0.05)' : 'rgba(249, 115, 22, 0.05)' }]}>
                    <Text style={[styles.significatorHouse, { color: colors.primary }]}>House {house}</Text>
                    <View style={styles.significatorChips}>
                        {significators.map((sig, idx) => (
                            <View key={idx} style={[styles.significatorChip, { backgroundColor: colors.primary + '20', borderColor: colors.primary }]}>
                                <Text style={[styles.significatorText, { color: colors.primary }]}>{sig}</Text>
                            </View>
                        ))}
                    </View>
                </View>
            ))}
        </ScrollView>
    );
};

const PlanetSignificatorsView = ({ data, theme, colors }) => {
    if (!data) return <Text style={[styles.errorText, { color: colors.textSecondary }]}>No data available</Text>;
    
    return (
        <ScrollView showsVerticalScrollIndicator={false}>
            {Object.entries(data).map(([planet, houses]) => (
                <View key={planet} style={[styles.significatorCard, { backgroundColor: theme === 'dark' ? 'rgba(255, 255, 255, 0.05)' : 'rgba(249, 115, 22, 0.05)' }]}>
                    <Text style={[styles.significatorHouse, { color: colors.primary }]}>{planet}</Text>
                    <View style={styles.significatorChips}>
                        {houses.map((house, idx) => (
                            <View key={idx} style={[styles.significatorChip, { backgroundColor: colors.primary + '20', borderColor: colors.primary }]}>
                                <Text style={[styles.significatorText, { color: colors.primary }]}>House {house}</Text>
                            </View>
                        ))}
                    </View>
                </View>
            ))}
        </ScrollView>
    );
};

const FourStepTheoryView = ({ data, theme, colors }) => {
    if (!data) return <Text style={[styles.errorText, { color: colors.textSecondary }]}>No data available</Text>;

    const renderStep = (num, label, lord, houses) => (
        <View style={styles.stepContainer}>
            <View style={styles.stepIndicator}>
                <View style={[styles.stepDot, { backgroundColor: colors.primary }]} />
                {num < 4 && <View style={[styles.stepLine, { backgroundColor: colors.primary + '30' }]} />}
            </View>
            <View style={styles.stepContent}>
                <Text style={[styles.stepNumber, { color: colors.textSecondary }]}>Step {num}: {label}</Text>
                <View style={styles.stepDetails}>
                    <Text style={[styles.stepLord, { color: colors.text }]}>{lord}</Text>
                    <View style={styles.stepHouses}>
                        {houses.length > 0 ? houses.map((h, idx) => (
                            <View key={idx} style={[styles.miniHouseChip, { backgroundColor: colors.primary + '10' }]}>
                                <Text style={[styles.miniHouseText, { color: colors.primary }]}>{h}</Text>
                            </View>
                        )) : <Text style={[styles.noHousesText, { color: colors.textSecondary }]}>No houses</Text>}
                    </View>
                </View>
            </View>
        </View>
    );

    return (
        <ScrollView showsVerticalScrollIndicator={false}>
            {Object.entries(data).map(([planet, steps]) => (
                <View key={planet} style={[styles.fourStepCard, { 
                    backgroundColor: Platform.OS === 'android' 
                        ? (theme === 'dark' ? 'rgba(0, 0, 0, 0.2)' : 'rgba(249, 115, 22, 0.08)')
                        : (theme === 'dark' ? 'rgba(255, 255, 255, 0.03)' : 'rgba(249, 115, 22, 0.03)'), 
                    borderColor: colors.primary + '20' 
                }]}>
                    <View style={styles.fourStepHeader}>
                        <View style={[styles.planetIconCircle, { backgroundColor: colors.primary }]}>
                            <Text style={styles.planetIconText}>{planet.substring(0, 2)}</Text>
                        </View>
                        <Text style={[styles.fourStepPlanetTitle, { color: colors.text }]}>{planet} Analysis</Text>
                    </View>
                    
                    <View style={styles.stepsList}>
                        {renderStep(1, 'Planet', steps.planet.name, steps.planet.houses)}
                        {renderStep(2, 'Star Lord', steps.star_lord.name, steps.star_lord.houses)}
                        {renderStep(3, 'Sub Lord', steps.sub_lord.name, steps.sub_lord.houses)}
                        {renderStep(4, 'Sub-Sub Lord', steps.sub_sub_lord.name, steps.sub_sub_lord.houses)}
                    </View>
                </View>
            ))}
        </ScrollView>
    );
};

const RulingPlanetsView = ({ data, theme, colors }) => {
    if (!data) return null;

    const renderRPChip = (label, value) => (
        <View style={[styles.rpChip, { backgroundColor: colors.primary + '15', borderColor: colors.primary + '40' }]}>
            <Text style={[styles.rpChipLabel, { color: colors.textSecondary }]}>{label}:</Text>
            <Text style={[styles.rpChipValue, { color: colors.primary }]}>{value}</Text>
        </View>
    );

    return (
        <View style={styles.rpContainer}>
            <View style={[styles.rpCard, { 
                backgroundColor: Platform.OS === 'android'
                    ? (theme === 'dark' ? 'rgba(0, 0, 0, 0.2)' : 'rgba(249, 115, 22, 0.08)')
                    : (theme === 'dark' ? 'rgba(255, 255, 255, 0.03)' : 'rgba(249, 115, 22, 0.03)'), 
                borderColor: colors.primary + '30' 
            }]}>
                <View style={styles.rpHeader}>
                    <Ionicons name="flash" size={16} color={colors.primary} />
                    <Text style={[styles.rpTitle, { color: colors.text }]}>Ruling Planets (Birth Moment)</Text>
                </View>
                
                <View style={styles.rpSection}>
                    <Text style={[styles.rpSectionTitle, { color: colors.textSecondary }]}>Ascendant</Text>
                    <View style={styles.rpChipGroup}>
                        {renderRPChip('Sign', data.ascendant.sign_lord)}
                        {renderRPChip('Star', data.ascendant.star_lord)}
                        {renderRPChip('Sub', data.ascendant.sub_lord)}
                    </View>
                </View>

                <View style={styles.rpSection}>
                    <Text style={[styles.rpSectionTitle, { color: colors.textSecondary }]}>Moon</Text>
                    <View style={styles.rpChipGroup}>
                        {renderRPChip('Sign', data.moon.sign_lord)}
                        {renderRPChip('Star', data.moon.star_lord)}
                        {renderRPChip('Sub', data.moon.sub_lord)}
                    </View>
                </View>

                <View style={styles.rpFooter}>
                    <View style={[styles.dayLordBadge, { backgroundColor: colors.primary }]}>
                        <Text style={styles.dayLordLabel}>Day Lord</Text>
                        <Text style={styles.dayLordValue}>{data.day_lord}</Text>
                    </View>
                </View>
            </View>
        </View>
    );
};

const KPScreen = ({ route, navigation }) => {
    const { birthDetails: initialBirthDetails } = route.params || {};
    const [birthDetails, setBirthDetails] = useState(initialBirthDetails);
    const [activeTab, setActiveTab] = useState('planets');
    const [processedData, setProcessedData] = useState(null);
    const [rulingPlanets, setRulingPlanets] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const { t } = useTranslation();
    const { theme, colors } = useTheme();
    const fadeAnim = useRef(new Animated.Value(0)).current;

    useEffect(() => {
        fetchAndProcessKPData();
        Animated.timing(fadeAnim, {
            toValue: 1,
            duration: 800,
            useNativeDriver: true,
        }).start();
    }, [birthDetails]);

    useEffect(() => {
        const unsubscribe = navigation.addListener('focus', () => {
            // Check if birthDetails changed in SelectNative
            if (route.params?.birthDetails) {
                const newDetails = route.params.birthDetails;
                // Only update if it's actually different to avoid infinite loops
                if (newDetails.name !== birthDetails?.name || 
                    newDetails.date !== birthDetails?.date || 
                    newDetails.time !== birthDetails?.time) {
                    setBirthDetails(newDetails);
                }
            }
        });
        return unsubscribe;
    }, [navigation, route.params?.birthDetails, birthDetails]);

    const fetchAndProcessKPData = async () => {
        if (!birthDetails || !birthDetails.date || !birthDetails.time) {
            setError('Birth details are incomplete.');
            setLoading(false);
            return;
        }
        try {
            setLoading(true);
            const apiPayload = {
                birth_date: birthDetails.date.split('T')[0],
                birth_time: birthDetails.time.split('T')[1] ? birthDetails.time.split('T')[1].slice(0, 5) : birthDetails.time,
                latitude: birthDetails.latitude,
                longitude: birthDetails.longitude,
                timezone: '',
            };
            
            // Fetch both KP Chart and Ruling Planets in parallel
            const [response, rpResponse] = await Promise.all([
                kpAPI.getKPChart(apiPayload),
                kpAPI.getRulingPlanets(apiPayload)
            ]);

            if (response.data && response.data.success) {
                const rawData = response.data.data;
                const planetsData = Object.keys(rawData.planet_positions).map(p => ({
                    planet: p,
                    longitude: rawData.planet_positions[p],
                    ...rawData.planet_lords[p]
                }));
                const cuspsData = Object.keys(rawData.house_cusps).map(c => ({
                    cusp: c,
                    longitude: rawData.house_cusps[c],
                    ...rawData.cusp_lords[c]
                }));
                setProcessedData({
                    planets: planetsData,
                    cusps: cuspsData,
                    significators: rawData.significators,
                    planetSignificators: rawData.planet_significators,
                    fourStepTheory: rawData.four_step_theory,
                });
            } else {
                setError(response.data.detail || 'Failed to fetch KP data.');
            }

            if (rpResponse.data && rpResponse.data.success) {
                setRulingPlanets(rpResponse.data.data);
            }
        } catch (e) {
            setError(e.message || 'An error occurred.');
            console.error("KP API Error:", e.response?.data || e);
        } finally {
            setLoading(false);
        }
    };

    const renderContent = () => {
        if (loading) {
            return (
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={colors.primary} />
                    <Text style={[styles.loadingText, { color: colors.text }]}>Loading KP Analysis...</Text>
                </View>
            );
        }
        if (error) {
            return <Text style={[styles.errorText, { color: colors.error }]}>{error}</Text>;
        }
        if (!processedData) {
            return <Text style={{ color: colors.textSecondary }}>No data available</Text>;
        }

        switch (activeTab) {
            case 'planets':
                return (
                    <ScrollView showsVerticalScrollIndicator={false} style={{ flex: 1 }}>
                        <RulingPlanetsView data={rulingPlanets} theme={theme} colors={colors} />
                        <PlanetaryTable data={processedData.planets} theme={theme} colors={colors} />
                    </ScrollView>
                );
            case 'cusps':
                return <CuspalTable data={processedData.cusps} theme={theme} colors={colors} />;
            case 'significators':
                return <SignificatorsView data={processedData.significators} theme={theme} colors={colors} />;
            case 'planetSignificators':
                return <PlanetSignificatorsView data={processedData.planetSignificators} theme={theme} colors={colors} />;
            case 'fourStep':
                return <FourStepTheoryView data={processedData.fourStepTheory} theme={theme} colors={colors} />;
            default:
                return null;
        }
    };

    return (
        <View style={{ flex: 1 }}>
            <LinearGradient
                colors={theme === 'dark' 
                    ? ['#1a0033', '#2d1b4e', '#4a2c6d', '#ff6b35']
                    : ['#fefcfb', '#fef7f0', '#fed7d7', '#fefcfb']}
                style={styles.container}
            >
                <SafeAreaView style={styles.safeArea}>
                    <View style={styles.header}>
                        <TouchableOpacity onPress={() => navigation.goBack()} style={styles.backButton}>
                            <Ionicons name="arrow-back" size={24} color={colors.text} />
                        </TouchableOpacity>
                        <View style={styles.headerCenter}>
                            <Text style={[styles.headerTitle, { color: colors.text }]}>ðŸŽ¯ KP System</Text>
                            {birthDetails && (
                                <NativeSelectorChip 
                                    birthData={birthDetails}
                                    onPress={() => navigation.navigate('SelectNative', { returnTo: 'KP' })}
                                    maxLength={7}
                                />
                            )}
                        </View>
                        <View style={{ width: 40 }} />
                    </View>

                    <Animated.View style={[styles.content, { opacity: fadeAnim }]}>
                        <View style={styles.tabContainer}>
                            <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={{ gap: 8 }}>
                                {['planets', 'cusps', 'significators', 'planetSignificators', 'fourStep'].map((tab) => (
                                    <TouchableOpacity
                                        key={tab}
                                        onPress={() => setActiveTab(tab)}
                                        style={[styles.tab, activeTab === tab && styles.activeTab]}
                                    >
                                        <LinearGradient
                                            colors={activeTab === tab 
                                                ? ['#ff6b35', '#ff8c5a']
                                                : Platform.OS === 'android'
                                                    ? (theme === 'dark' ? ['rgba(255, 255, 255, 0.15)', 'rgba(255, 255, 255, 0.1)'] : ['rgba(249, 115, 22, 0.15)', 'rgba(249, 115, 22, 0.1)'])
                                                    : (theme === 'dark' ? ['rgba(255, 255, 255, 0.1)', 'rgba(255, 255, 255, 0.05)'] : ['rgba(249, 115, 22, 0.1)', 'rgba(249, 115, 22, 0.05)'])}
                                            style={styles.tabGradient}
                                        >
                                            <Text style={[styles.tabText, { color: activeTab === tab ? '#fff' : colors.text }]}>
                                                {tab === 'planets' ? 'Planets' : 
                                                 tab === 'cusps' ? 'Cusps' : 
                                                 tab === 'significators' ? 'H-Sig' : 
                                                 tab === 'planetSignificators' ? 'P-Sig' : '4-Step'}
                                            </Text>
                                        </LinearGradient>
                                    </TouchableOpacity>
                                ))}
                            </ScrollView>
                        </View>

                        <View style={[styles.contentCard, { backgroundColor: theme === 'dark' ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.9)' }]}>
                            {renderContent()}
                            
                            <View style={[styles.legend, { backgroundColor: theme === 'dark' ? 'rgba(255, 107, 53, 0.1)' : 'rgba(249, 115, 22, 0.08)' }]}>
                                <Text style={[styles.legendTitle, { color: colors.text }]}>Legend:</Text>
                                <Text style={[styles.legendText, { color: colors.textSecondary }]}>SL = Sign Lord  â€¢  NL = Nakshatra Lord  â€¢  SB = Sub Lord  â€¢  SS = Sub-Sub Lord  â€¢  Pd = Pada</Text>
                            </View>
                        </View>
                    </Animated.View>
                </SafeAreaView>
            </LinearGradient>
        </View>
    );
};

const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
    safeArea: {
        flex: 1,
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 16,
        paddingVertical: 12,
    },
    backButton: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: 'rgba(255, 255, 255, 0.15)',
        justifyContent: 'center',
        alignItems: 'center',
    },
    headerTitle: {
        fontSize: 20,
        fontWeight: '800',
    },
    headerCenter: {
        flex: 1,
        alignItems: 'center',
        justifyContent: 'center',
        gap: 4,
    },
    content: {
        flex: 1,
        padding: 16,
    },
    tabContainer: {
        flexDirection: 'row',
        gap: 8,
        marginBottom: 16,
    },
    tab: {
        flex: 1,
        borderRadius: 12,
        overflow: 'hidden',
    },
    tabGradient: {
        paddingVertical: 12,
        paddingHorizontal: 16,
        alignItems: 'center',
        borderRadius: 12,
    },
    tabText: {
        fontSize: 14,
        fontWeight: '600',
    },
    contentCard: {
        flex: 1,
        borderRadius: 16,
        padding: 16,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.1,
        shadowRadius: 8,
        elevation: 4,
        // Android Glassmorphism Fix - Use dark tint instead of white
        backgroundColor: Platform.OS === 'android' ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.05)',
    },
    loadingContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
    },
    loadingText: {
        marginTop: 16,
        fontSize: 16,
        fontWeight: '600',
    },
    errorText: {
        fontSize: 14,
        textAlign: 'center',
        marginTop: 20,
    },
    table: {
        minWidth: '100%',
    },
    tableRow: {
        flexDirection: 'row',
        paddingVertical: 12,
        borderBottomWidth: 1,
        borderBottomColor: 'rgba(0, 0, 0, 0.25)',
    },
    tableRowAlt: {
        backgroundColor: 'rgba(249, 115, 22, 0.03)',
    },
    tableHeader: {
        fontSize: 12,
        fontWeight: '700',
        paddingHorizontal: 8,
        borderRightWidth: 1,
        borderRightColor: 'rgba(0, 0, 0, 0.25)',
    },
    tableCell: {
        fontSize: 12,
        paddingHorizontal: 8,
        borderRightWidth: 1,
        borderRightColor: 'rgba(0, 0, 0, 0.2)',
    },
    significatorCard: {
        padding: 16,
        borderRadius: 12,
        marginBottom: 12,
        borderWidth: 1,
        borderColor: 'rgba(249, 115, 22, 0.2)',
        // Android Glassmorphism Fix - Use dark tint instead of white
        backgroundColor: Platform.OS === 'android' ? 'rgba(0, 0, 0, 0.15)' : 'rgba(255, 255, 255, 0.05)',
    },
    significatorHouse: {
        fontSize: 16,
        fontWeight: '700',
        marginBottom: 12,
    },
    significatorChips: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 8,
    },
    significatorChip: {
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 12,
        borderWidth: 1,
    },
    significatorText: {
        fontSize: 13,
        fontWeight: '600',
    },
    legend: {
        marginTop: 16,
        padding: 12,
        borderRadius: 12,
        borderWidth: 1,
        borderColor: 'rgba(249, 115, 22, 0.2)',
    },
    legendTitle: {
        fontSize: 13,
        fontWeight: '700',
        marginBottom: 6,
    },
    legendText: {
        fontSize: 12,
        lineHeight: 18,
    },
    // Ruling Planets Styles
    rpContainer: {
        marginBottom: 16,
    },
    rpCard: {
        padding: 12,
        borderRadius: 12,
        borderWidth: 1,
    },
    rpTitle: {
        fontSize: 14,
        fontWeight: '800',
        marginBottom: 8,
        textAlign: 'center',
    },
    rpSection: {
        marginBottom: 6,
    },
    rpSectionTitle: {
        fontSize: 12,
        fontWeight: '700',
    },
    rpText: {
        fontSize: 12,
    },
    // 4-Step Theory Improved Styles
    fourStepHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 12,
        marginBottom: 16,
        borderBottomWidth: 1,
        borderBottomColor: 'rgba(0,0,0,0.05)',
        paddingBottom: 12,
    },
    planetIconCircle: {
        width: 36,
        height: 36,
        borderRadius: 18,
        justifyContent: 'center',
        alignItems: 'center',
    },
    planetIconText: {
        color: '#fff',
        fontSize: 14,
        fontWeight: '800',
    },
    fourStepPlanetTitle: {
        fontSize: 18,
        fontWeight: '800',
    },
    stepsList: {
        paddingLeft: 4,
    },
    stepContainer: {
        flexDirection: 'row',
        minHeight: 50,
    },
    stepIndicator: {
        width: 20,
        alignItems: 'center',
    },
    stepDot: {
        width: 8,
        height: 8,
        borderRadius: 4,
        marginTop: 6,
    },
    stepLine: {
        width: 2,
        flex: 1,
        marginVertical: 2,
    },
    stepContent: {
        flex: 1,
        paddingLeft: 12,
        paddingBottom: 16,
    },
    stepNumber: {
        fontSize: 10,
        fontWeight: '600',
        textTransform: 'uppercase',
        marginBottom: 2,
    },
    stepDetails: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
    },
    stepLord: {
        fontSize: 14,
        fontWeight: '700',
    },
    stepHouses: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 4,
        justifyContent: 'flex-end',
        flex: 1,
        marginLeft: 10,
    },
    miniHouseChip: {
        paddingHorizontal: 6,
        paddingVertical: 2,
        borderRadius: 4,
    },
    miniHouseText: {
        fontSize: 10,
        fontWeight: '700',
    },
    noHousesText: {
        fontSize: 10,
        fontStyle: 'italic',
    },
    // Ruling Planets Improved Styles
    rpHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 6,
        marginBottom: 12,
    },
    rpChipGroup: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 8,
        marginTop: 4,
    },
    rpChip: {
        flexDirection: 'row',
        paddingHorizontal: 10,
        paddingVertical: 6,
        borderRadius: 20,
        borderWidth: 1,
        alignItems: 'center',
        gap: 4,
    },
    rpChipLabel: {
        fontSize: 10,
        fontWeight: '600',
        textTransform: 'uppercase',
    },
    rpChipValue: {
        fontSize: 12,
        fontWeight: '700',
    },
    rpFooter: {
        marginTop: 12,
        alignItems: 'center',
        borderTopWidth: 1,
        borderTopColor: 'rgba(0,0,0,0.05)',
        paddingTop: 12,
    },
    dayLordBadge: {
        flexDirection: 'row',
        paddingHorizontal: 16,
        paddingVertical: 8,
        borderRadius: 25,
        alignItems: 'center',
        gap: 8,
        elevation: 2,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
    },
    dayLordLabel: {
        color: 'rgba(255,255,255,0.8)',
        fontSize: 11,
        fontWeight: '600',
    },
    dayLordValue: {
        color: '#fff',
        fontSize: 14,
        fontWeight: '800',
    },
});

export default KPScreen;
